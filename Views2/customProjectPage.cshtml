@using Umbraco.Cms.Web.Common.PublishedModels;
@inherits Umbraco.Cms.Web.Common.Views.UmbracoViewPage
@using Umbraco.Cms.Core.Models.PublishedContent
@using Umbraco.Cms.Core.Web
@using Newtonsoft.Json
@using System.Text.RegularExpressions
@{
    Layout = "masterLayout.cshtml";
    
    var pageTitle = Model.Value<string>("pageTitle");
    ViewBag.Title = pageTitle;
    
    // URL Tanımları
    var currentUrl = $"{Context.Request.Scheme}://{Context.Request.Host}{Context.Request.Path}";
    var siteUrl = $"{Context.Request.Scheme}://{Context.Request.Host}";
    
    // Meta Verileri
    var metaDesc = Model.Value<string>("metaDescription");
    if(string.IsNullOrEmpty(metaDesc)) {
        metaDesc = pageTitle; // Fallback
    }

    // Proje Listesi Filtreleme
    var selectedProjects = Model.Value<IEnumerable<IPublishedContent>>("selectedProjects") ?? Enumerable.Empty<IPublishedContent>();
    var projectsList = selectedProjects.Where(p => p != null && p.IsVisible() && p.ContentType.Alias == "projectaa").ToList();

    // --- READ MORE (DEVAMINI OKU) MANTIĞI (MEVCUT KOD KORUNDU) ---
    var featuredImage = Model.Value<IPublishedContent>("featuredImage");
    var postContent = Model.Value<string>("postContent");
    var processedContent = postContent;
    
    if (!string.IsNullOrEmpty(postContent))
    {
        var h2Pattern = @"<h2[^>]*>";
        var h2Matches = Regex.Matches(postContent, h2Pattern, RegexOptions.IgnoreCase);
        
        if (h2Matches.Count >= 2)
        {
            var secondH2Index = h2Matches[1].Index;
            var beforeSecondH2 = postContent.Substring(0, secondH2Index);
            var afterSecondH2 = postContent.Substring(secondH2Index);
            
            var readMoreHtml = @"
                <div class='read-more-wrapper' style='margin: 30px 0;'>
                    <div class='read-more-content' style='max-height: 0; overflow: hidden; transition: max-height 0.3s ease;'>
            ";
            
            var readMoreButton = @"
                    </div>
                    <button class='read-more-btn' onclick='toggleReadMore(this)' style='background: #2c5f2d; color: white; border: none; padding: 12px 24px; border-radius: 5px; cursor: pointer; font-size: 16px; margin-top: 20px;'>
                        Devamını Oku
                    </button>
                </div>
            ";
            
            processedContent = beforeSecondH2 + readMoreHtml + afterSecondH2 + readMoreButton;
        }
    }
}

@* --- SEO İÇİN OPTİMİZE EDİLMİŞ YAPILANDIRILMIŞ VERİ (CollectionPage + ItemList) --- *@
@if (projectsList.Any())
{
    <script type="application/ld+json">
    {
      "@@context": "https://schema.org",
      "@@graph": [
        {
          "@@type": "CollectionPage",
          "@@id": "@currentUrl#collectionpage",
          "url": "@currentUrl",
          "name": @Html.Raw(JsonConvert.SerializeObject(pageTitle)),
          "description": @Html.Raw(JsonConvert.SerializeObject(metaDesc)),
          "isPartOf": { "@@id": "@siteUrl/#website" },
          "about": { "@@id": "@siteUrl/#organization" },
          "inLanguage": "tr-TR",
          "mainEntity": { "@@id": "@currentUrl#itemlist" }
        },
        {
          "@@type": "ItemList",
          "@@id": "@currentUrl#itemlist",
          "name": "@pageTitle Listesi",
          "itemListOrder": "https://schema.org/ItemListUnordered",
          "numberOfItems": @projectsList.Count,
          "itemListElement": [
            @for (int i = 0; i < projectsList.Count; i++)
            {
                var project = projectsList[i];
                var pUrl = project.Url(mode: UrlMode.Absolute);
                var pName = project.Name;
                var pImageObj = project.Value<IPublishedContent>("projectImage");
                var pImageUrl = pImageObj?.Url(mode: UrlMode.Absolute) ?? "";
                
                var isLast = (i == projectsList.Count - 1);
                
                <text>
                {
                  "@@type": "ListItem",
                  "position": @(i + 1),
                  "item": {
                    "@@type": "WebPage",
                    "@@id": "@pUrl",
                    "url": "@pUrl",
                    "name": @Html.Raw(JsonConvert.SerializeObject(pName)),
                    "image": "@pImageUrl"
                  }
                }@(isLast ? "" : ",")
                </text>
            }
          ]
        }
      ]
    }
    </script>
}

@await Html.PartialAsync("CustomProjectCards", Model, new ViewDataDictionary(ViewData) 
{
    { "SelectedProjects", projectsList },
    { "PageTitle", pageTitle },
    { "PageDescription", Model.Value<string>("pageDescription") }
})

<style>
    .projects-section {
        padding-top: 140px !important; 
    }
    
    .read-more-wrapper {
        margin: 30px 0;
    }
    
    .read-more-content {
        transition: max-height 0.3s ease;
    }
    
    .read-more-btn {
        background: #045129 !important;
        transition: background 0.3s ease;
    }
    
    .read-more-btn:hover {
        background: #1e4620;
    }
</style>

<link href="/css/blog.css" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/swiper@11/swiper-bundle.min.js"></script>
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/swiper@11/swiper-bundle.min.css"/>

<div class="container blog-post-container" style="padding-top:0px !important">
    <article>
        
        @if (featuredImage != null)
        {
            <div class="blog-post-featured-image">
                <img src="@featuredImage.Url()" alt="@Model.Name" />
            </div>
        }

        <div class="blog-post-content" style="max-width: 1050px !important">
            @Html.Raw(processedContent)
        </div>
    </article>
</div>

<script>
function toggleReadMore(button) {
    var wrapper = button.parentElement;
    var content = wrapper.querySelector('.read-more-content');
    
    if (content.style.maxHeight === '0px' || content.style.maxHeight === '') {
        content.style.maxHeight = content.scrollHeight + 'px';
        button.textContent = 'Daha Az Göster';
    } else {
        content.style.maxHeight = '0px';
        button.textContent = 'Devamını Oku';
        
        // Scroll animasyonu ile wrapper'ın 100px üstüne git
        setTimeout(function() {
            var wrapperPosition = wrapper.getBoundingClientRect().top + window.pageYOffset;
            var offsetPosition = wrapperPosition - 400;
            
            window.scrollTo({
                top: offsetPosition,
                behavior: 'smooth'
            });
        }, 100);
    }
}
</script>

@await Html.PartialAsync("FAQ")
@await Html.PartialAsync("deneme")