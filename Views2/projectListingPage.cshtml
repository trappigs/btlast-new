@using Umbraco.Cms.Web.Common.PublishedModels;
@using Umbraco.Cms.Core.Models.PublishedContent
@using Umbraco.Cms.Core.Web
@using Newtonsoft.Json 
@inherits Umbraco.Cms.Web.Common.Views.UmbracoViewPage
@{
    Layout = "masterLayout.cshtml";
    ViewBag.Title = "Projelerimiz";

    var projects = Model.Children().Where(x => x.IsVisible()).ToList();
    
    // Graph bağlantıları için URL köklerini alıyoruz
    var siteUrl = $"{Context.Request.Scheme}://{Context.Request.Host}";
    var currentUrl = Model.Url(mode: UrlMode.Absolute);
    
    // Meta açıklama kontrolü
    var metaDesc = Model.Value<string>("metaDescription");
    if(string.IsNullOrEmpty(metaDesc)) {
        metaDesc = "Bereketli Topraklar güvencesiyle satılık imarlı, müstakil tapulu arsa projeleri.";
    }
}

@* --- SEO İÇİN GELİŞMİŞ YAPILANDIRILMIŞ VERİ (CollectionPage + ItemList) --- *@
<script type="application/ld+json">
{
  "@@context": "https://schema.org",
  "@@graph": [
    {
      "@@type": "CollectionPage",
      "@@id": "@currentUrl#collectionpage",
      "url": "@currentUrl",
      "name": "@Model.Name | Bereketli Topraklar",
      "description": @Html.Raw(JsonConvert.SerializeObject(metaDesc)),
      "isPartOf": { "@@id": "@siteUrl/#website" },
      "about": { "@@id": "@siteUrl/#organization" },
      "inLanguage": "tr-TR",
      "mainEntity": { "@@id": "@currentUrl#itemlist" }
    },
    {
      "@@type": "ItemList",
      "@@id": "@currentUrl#itemlist",
      "name": "Bereketli Topraklar Proje Listesi",
      "itemListOrder": "https://schema.org/ItemListUnordered",
      "numberOfItems": @projects.Count,
      "itemListElement": [
        @for (int i = 0; i < projects.Count; i++)
        {
            var project = projects[i];
            var pUrl = project.Url(mode: UrlMode.Absolute);
            var pName = project.Name;
            var pImageObj = project.Value<IPublishedContent>("projectImage");
            var pImageUrl = pImageObj?.Url(mode: UrlMode.Absolute) ?? "";
            
            // Son eleman kontrolü (virgül hatası olmaması için)
            var isLast = (i == projects.Count - 1);
            
            <text>
            {
              "@@type": "ListItem",
              "position": @(i + 1),
              "item": {
                "@@type": "WebPage",
                "@@id": "@pUrl",
                "url": "@pUrl",
                "name": @Html.Raw(JsonConvert.SerializeObject(pName)),
                "image": "@pImageUrl"
              }
            }@(isLast ? "" : ",")
            </text>
        }
      ]
    }
  ]
}
</script>

@* ProjectCards partial'ını çağırırken "IsProjectListPage" parametresini true olarak gönderiyoruz *@
@await Html.PartialAsync("ProjectCards", Model, new ViewDataDictionary(ViewData) { { "IsProjectListPage", true } })


<style>
    /* .projects-section, ProjectCards.cshtml partial'ının ana taşıyıcısıdır. */
    /* !important kullanarak harici CSS dosyasındaki kuralı ezdiğimizden emin oluyoruz. */
    .projects-section {
        padding-top: 140px !important; 
    }
</style>