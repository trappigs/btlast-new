@using Umbraco.Cms.Web.Common.PublishedModels;
@inherits Umbraco.Cms.Web.Common.Views.UmbracoViewPage
@using Umbraco.Cms.Core.Models.PublishedContent
@using Umbraco.Cms.Core.Web
@using Newtonsoft.Json
@{
    Layout = "masterLayout.cshtml";
    ViewBag.Title = Model.Value("pageTitle");
    
    // Haberleri tarihe göre sırala
    var posts = Model.Children()
                     .Where(x => x.IsVisible())
                     .OrderByDescending(x => x.Value<DateTime>("postDate") != default(DateTime) ? x.Value<DateTime>("postDate") : x.CreateDate)
                     .ToList();

    var siteUrl = $"{Context.Request.Scheme}://{Context.Request.Host}";
    var currentUrl = Model.Url(mode: UrlMode.Absolute);
    
    var metaDesc = Model.Value<string>("metaDescription");
    if(string.IsNullOrEmpty(metaDesc)) metaDesc = Model.Value<string>("pageTitle");
}

<link href="/css/blog.css" rel="stylesheet">
<link rel="stylesheet" href="/css/contact-page.css">

@* --- SEO: COLLECTIONPAGE + ITEMLIST (NEWSARTICLE) --- *@
<script type="application/ld+json">
{
  "@@context": "https://schema.org",
  "@@graph": [
    {
      "@@type": "CollectionPage",
      "@@id": "@currentUrl#collectionpage",
      "url": "@currentUrl",
      "name": @Html.Raw(JsonConvert.SerializeObject(Model.Value<string>("pageTitle"))),
      "description": @Html.Raw(JsonConvert.SerializeObject(metaDesc)),
      "isPartOf": { "@@id": "@siteUrl/#website" },
      "about": { "@@id": "@siteUrl/#organization" },
      "inLanguage": "tr-TR",
      "mainEntity": { "@@id": "@currentUrl#itemlist" }
    },
    {
      "@@type": "ItemList",
      "@@id": "@currentUrl#itemlist",
      "name": "Haberler ve Duyurular Listesi",
      "itemListOrder": "https://schema.org/ItemListOrderDescending",
      "numberOfItems": @posts.Count,
      "itemListElement": [
        @for (int i = 0; i < posts.Count; i++)
        {
            var post = posts[i];
            
            // --- URL MANTIĞI ---
            string postUrl;
            var customCanonical = post.Value<string>("canonicalLink");
            if (!string.IsNullOrWhiteSpace(customCanonical))
            {
                // Eğer canonical "http" ile başlamıyorsa siteUrl ekle, başlıyorsa direkt al
                postUrl = customCanonical.StartsWith("http") ? customCanonical : siteUrl + "/" + customCanonical.TrimStart('/');
                // Slash kontrolü
                if(!postUrl.EndsWith("/")) postUrl += "/";
            }
            else
            {
                postUrl = post.Url(mode: UrlMode.Absolute);
            }

            // --- GÖRSEL MANTIĞI ---
            // Önce featuredImage (HTML'de kullanılan), yoksa ogImage
            var pImageObj = post.Value<IPublishedContent>("featuredImage") ?? post.Value<IPublishedContent>("ogImage");
            var pImageUrl = pImageObj?.Url(mode: UrlMode.Absolute) ?? "";

            // --- TARİH MANTIĞI ---
            var pDateVal = post.Value<DateTime>("postDate");
            if (pDateVal == default(DateTime)) pDateVal = post.CreateDate;
            var pDateIso = pDateVal.ToString("yyyy-MM-dd"); // Schema için ISO formatı

            // --- YAZAR ---
            var pAuthor = post.Value<string>("articleAuthor");
            if(string.IsNullOrWhiteSpace(pAuthor)) pAuthor = "Bereketli Topraklar";

            var isLast = (i == posts.Count - 1);
            
            <text>
            {
              "@@type": "ListItem",
              "position": @(i + 1),
              "item": {
                "@@type": "NewsArticle",
                "@@id": "@postUrl",
                "url": "@postUrl",
                "headline": @Html.Raw(JsonConvert.SerializeObject(post.Name)),
                "datePublished": "@pDateIso",
                "image": "@pImageUrl",
                "author": { 
                    "@@type": "Organization",
                    "name": "@pAuthor",
                    "url": "@siteUrl"
                }
              }
            }@(isLast ? "" : ",")
            </text>
        }
      ]
    }
  ]
}
</script>

<section class="contact-hero"> 
    <div class="container text-center">
        <span class="contact-hero-subtitle">@Model.Value("altBaslik")</span>
        <h1 class="contact-hero-title">@Model.Value("pageTitle")</h1> 
        <p class="contact-hero-text">@Model.Value("pageDescription")</p> 
    </div>
</section>

<div class="blog-listing-container">
    <div class="container">
        <div class="blog-grid-listing"> 
             @foreach (var post in posts)
            {
                var featuredImage = post.Value<IPublishedContent>("featuredImage");
                var excerpt = post.Value<string>("excerpt");

                // URL Mantığı (Schema ile birebir aynı olmalı)
                string postUrl;
                var customCanonical = post.Value<string>("canonicalLink");
                if (!string.IsNullOrWhiteSpace(customCanonical))
                {
                     postUrl = customCanonical.StartsWith("http") ? customCanonical : siteUrl + "/" + customCanonical.TrimStart('/');
                     if(!postUrl.EndsWith("/")) postUrl += "/";
                }
                else
                {
                    postUrl = post.Url(mode: UrlMode.Absolute);
                }

                // Tarih Mantığı
                var postDate = post.Value<DateTime>("postDate");
                if (postDate == default(DateTime)) {
                    postDate = post.CreateDate;
                }
                var formattedDate = postDate.ToString("dd MMMM yyyy", new System.Globalization.CultureInfo("tr-TR"));
                
                <div class="blog-card">
                    @if (featuredImage != null)
                    {
                        <div class="blog-card-image">
                            <a href="@postUrl">
                                <img src="@featuredImage.Url()" alt="@post.Name" loading="lazy">
                            </a>
                        </div>
                    }
                    <div class="blog-card-content">
                        <div class="blog-card-date">@formattedDate</div>
                        <a href="@postUrl" class="blog-card-title">@post.Name</a>
                        
                        @if (!string.IsNullOrWhiteSpace(excerpt))
                        {
                            <div class="blog-card-excerpt">
                                @Html.Raw(excerpt)
                            </div>
                        }
                      
                        <div class="blog-card-author">
                           Yazar: @(post.HasValue("articleAuthor") ? post.Value("articleAuthor") : "Bereketli Topraklar")
                        </div>
                    </div>
                </div>
            }
        </div>
    </div>
</div>